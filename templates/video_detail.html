{% extends "base.html" %}

{% block title %}{{ video.title }} - 视频播放平台{% endblock %}

{% block content %}
<div class="video-detail">
    <div class="video-player-container">
        <video id="videoPlayer" class="video-player" controls playsinline webkit-playsinline>
            <source src="{{ video.video_url }}" type="video/mp4">
            您的浏览器不支持视频播放。
        </video>
        <!-- 覆盖播放按钮 -->
        <div id="videoOverlay" class="video-overlay" role="button" aria-label="播放视频">
            <div class="overlay-inner">
                <div class="overlay-play-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="44" height="44" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z"/>
                    </svg>
                </div>
                <div class="overlay-text">点击播放</div>
            </div>
        </div>
    </div>
    
    <div class="video-info-detail">
        <h1>{{ video.title }}</h1>
        <div class="video-meta-detail">
            <span class="view-count">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                    <path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/>
                </svg>
                <span class="view-count-number">{{ video.view_count }}</span> 次播放
            </span>
        </div>
        {% if video.description %}
        <div class="video-description-detail">
            <h3>视频简介</h3>
            <p>{{ video.description }}</p>
        </div>
        {% endif %}
    </div>
    
    <div class="comments-section">
        <div class="comments-list">
            <h2>精彩评论</h2>
            {% if comments.items %}
                {% for comment in comments.items %}
                <div class="comment-item">
                    <div class="comment-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
                        </svg>
                    </div>
                    <div class="comment-body">
                        <div class="comment-header">
                            <span class="comment-author">{{ comment.name }}</span>
                            <span class="comment-date">{{ comment.created_at.strftime('%m-%d %H:%M') }}</span>
                        </div>
                        <div class="comment-content">
                            {{ comment.content }}
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if comments.pages > 1 %}
                <div class="pagination">
                    {% if comments.has_prev %}
                        <a href="{{ url_for('video_detail', video_id=video.id, page=comments.prev_num) }}" class="page-link">上一页</a>
                    {% endif %}
                    
                    {% for page_num in comments.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                        {% if page_num %}
                            {% if page_num != comments.page %}
                                <a href="{{ url_for('video_detail', video_id=video.id, page=page_num) }}" class="page-link">{{ page_num }}</a>
                            {% else %}
                                <span class="page-link active">{{ page_num }}</span>
                            {% endif %}
                        {% else %}
                            <span class="page-ellipsis">...</span>
                        {% endif %}
                    {% endfor %}
                    
                    {% if comments.has_next %}
                        <a href="{{ url_for('video_detail', video_id=video.id, page=comments.next_num) }}" class="page-link">下一页</a>
                    {% endif %}
                </div>
                {% endif %}
            {% else %}
                <div class="no-comments">
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                    </svg>
                    <p>暂无评论，快来发表第一条评论吧！</p>
                </div>
            {% endif %}
        </div>
    </div>
    
    <!-- 添加底部空间，避免被悬浮评论框遮挡 -->
    <div style="height: 100px;"></div>
</div>

<!-- 悬浮评论输入框 -->
<div class="floating-comment-box">
    <div class="floating-comment-input" onclick="openCommentModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
            <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
        </svg>
        <span>写评论...</span>
    </div>
</div>

<!-- 评论模态框 -->
<div id="commentModal" class="comment-modal">
    <div class="comment-modal-content">
        <div class="comment-modal-header">
            <h3>发表评论</h3>
            <span class="close-modal" onclick="closeCommentModal()">&times;</span>
        </div>
        <form method="POST" action="{{ url_for('add_comment', video_id=video.id) }}" id="commentForm">
            <div class="form-group">
                <label for="name">姓名 <span class="required">*</span></label>
                <input type="text" id="name" name="name" required maxlength="100" placeholder="请输入您的姓名">
            </div>
            <div class="form-group">
                <label for="phone">手机号码 <span class="required">*</span></label>
                <input type="tel" id="phone" name="phone" required pattern="[0-9]{11}" maxlength="11" placeholder="请输入11位手机号码">
            </div>
            <div class="form-group">
                <label for="content">评论内容 <span class="required">*</span></label>
                <textarea id="content" name="content" rows="5" required maxlength="500" placeholder="请输入您的评论（最多500字）"></textarea>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                    </svg>
                    提交评论
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeCommentModal()">取消</button>
            </div>
            <p class="comment-notice">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                </svg>
                评论需要管理员审核后才会显示
            </p>
        </form>
    </div>
</div>

<script>
    // 视频播放器增强
    const video = document.getElementById('videoPlayer');
    const overlay = document.getElementById('videoOverlay');
    
    // 移动端视频优化
    if ('ontouchstart' in window) {
        video.setAttribute('x-webkit-airplay', 'allow');
        video.setAttribute('x5-video-player-type', 'h5');
        video.setAttribute('x5-video-player-fullscreen', 'true');
        video.setAttribute('x5-video-orientation', 'portraint');
    }
    
    // 初始：显示覆盖播放按钮
    function showOverlay() {
        if (overlay) overlay.classList.remove('hidden');
    }
    function hideOverlay() {
        if (overlay) overlay.classList.add('hidden');
    }
    showOverlay();
    
    // 点击覆盖层播放
    if (overlay) {
        overlay.addEventListener('click', function() {
            video.play().catch(() => {});
        });
    }
    
    // 根据播放状态切换覆盖层
    video.addEventListener('play', hideOverlay);
    video.addEventListener('pause', function() {
        // 在未开始或播放结束时显示覆盖层，其余暂停不显示
        if (video.currentTime === 0 || video.ended) showOverlay();
    });
    video.addEventListener('ended', showOverlay);
    
    // 智能播放策略
    let hasUserInteracted = false;
    document.addEventListener('click', function() {
        hasUserInteracted = true;
    }, { once: true });
    
    video.addEventListener('canplay', function() {
        // 只在用户交互后尝试自动播放（桌面端）
        if (hasUserInteracted && !('ontouchstart' in window)) {
            video.play().catch(function(error) {
                console.log('自动播放被阻止:', error);
            });
        }
    });
    
    // 评论模态框控制
    function openCommentModal() {
        document.getElementById('commentModal').style.display = 'flex';
        document.body.style.overflow = 'hidden'; // 禁止背景滚动
    }
    
    function closeCommentModal() {
        document.getElementById('commentModal').style.display = 'none';
        document.body.style.overflow = 'auto'; // 恢复滚动
    }
    
    // 点击模态框外部关闭
    window.onclick = function(event) {
        const modal = document.getElementById('commentModal');
        if (event.target == modal) {
            closeCommentModal();
        }
    }
    
    // 移动端手势支持
    let touchStartY = 0;
    const modal = document.getElementById('commentModal');
    const modalContent = modal.querySelector('.comment-modal-content');
    
    modalContent.addEventListener('touchstart', function(e) {
        touchStartY = e.touches[0].clientY;
    });
    
    modalContent.addEventListener('touchmove', function(e) {
        const touchY = e.touches[0].clientY;
        const scrollTop = modalContent.scrollTop;
        const isTop = scrollTop === 0;
        const isMovingDown = touchY > touchStartY;
        
        // 如果在顶部且向下滑动，关闭模态框
        if (isTop && isMovingDown && touchY - touchStartY > 50) {
            closeCommentModal();
        }
    });
    
    // 防止键盘弹出时页面变形
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', function() {
            if ('ontouchstart' in window) {
                setTimeout(() => {
                    window.scrollTo(0, 0);
                    document.body.scrollTop = 0;
                }, 300);
            }
        });
    });
    
    // 手机号码验证
    const phoneInput = document.getElementById('phone');
    phoneInput.addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });
    
    // 表单提交动画
    document.getElementById('commentForm').addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<span class="spinner"></span> 提交中...';
        submitBtn.disabled = true;
        
        // 移动端隐藏键盘
        if ('ontouchstart' in window) {
            document.activeElement.blur();
        }
    });
    
    // 移动端优化：点击外部关闭键盘
    document.addEventListener('touchstart', function(e) {
        if (!e.target.matches('input, textarea')) {
            document.activeElement.blur();
        }
    });
</script>
{% endblock %}